name: Build Multi-Platform Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v0.3.0, v0.3.1, etc.)

permissions:
  contents: write  # Needed to create releases

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Download Python Embebido
        run: python scripts/download_python_embed.py
      
      - name: Install pip in embedded Python (get-pip.py)
        working-directory: src-tauri/binaries/python-embed
        run: |
          curl -o get-pip.py https://bootstrap.pypa.io/get-pip.py
          .\python.exe get-pip.py
          .\python.exe -m pip install --upgrade pip setuptools wheel
          Remove-Item get-pip.py
      
      - name: Build Backend Bundle
        run: python scripts/build_backend_bundle.py
      
      - name: Prepare launcher for Windows
        run: |
          # Tauri busca archivos con sufijo de arquitectura en Windows tambien
          Copy-Item src-tauri/binaries/start-backend.bat src-tauri/binaries/start-backend-x86_64-pc-windows-msvc.exe
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Build Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"
      
      - name: Build Tauri (Windows)
        working-directory: src-tauri
        run: cargo tauri build
      
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: narrative-assistant-windows
          path: src-tauri/target/release/bundle/nsis/*.exe
  
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Download Python Framework
        run: python3 scripts/download_python_embed.py
      
      - name: Install pip in embedded Python
        working-directory: src-tauri/binaries/python-embed
        run: |
          curl -o get-pip.py https://bootstrap.pypa.io/get-pip.py
          ./python3 get-pip.py
          ./python3 -m pip install --upgrade pip setuptools wheel
          rm get-pip.py
      
      - name: Build Backend Bundle
        run: python3 scripts/build_backend_bundle.py
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Build Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0.0"
      
      - name: Prepare launcher scripts for macOS
        run: |
          chmod +x src-tauri/binaries/start-backend.sh
          # Tauri busca archivos con sufijo de arquitectura
          cp src-tauri/binaries/start-backend.sh src-tauri/binaries/start-backend-aarch64-apple-darwin
          cp src-tauri/binaries/start-backend.sh src-tauri/binaries/start-backend-x86_64-apple-darwin
          chmod +x src-tauri/binaries/start-backend-aarch64-apple-darwin
          chmod +x src-tauri/binaries/start-backend-x86_64-apple-darwin
      
      - name: Build Tauri (macOS)
        working-directory: src-tauri
        run: cargo tauri build
      
      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: narrative-assistant-macos
          path: src-tauri/target/release/bundle/dmg/*.dmg
  
  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: narrative-assistant-windows
          path: artifacts/windows
      
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: narrative-assistant-macos
          path: artifacts/macos
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/windows/*.exe
            artifacts/macos/*.dmg
          body: |
            ## Narrative Assistant ${{ github.ref_name }}
            
            **Instaladores multi-plataforma con Python embebido**
            
            ### Plataformas soportadas
            - ‚úÖ **Windows 10/11**: `Narrative-Assistant-Setup.exe` (~40-50 MB)
            - üß™ **macOS 11+**: `Narrative-Assistant.dmg` (~60-70 MB) - *Pendiente validaci√≥n en hardware*
            
            ### Caracter√≠sticas
            - ‚úÖ No requiere Python instalado en el sistema
            - ‚úÖ Instalaci√≥n simple para usuarios no t√©cnicos
            - ‚úÖ Primera ejecuci√≥n descarga modelos NLP (~900MB)
            - ‚úÖ Despu√©s funciona 100% offline
            
            ### Notas
            - **Windows**: Verificado funcional en v0.3.0
            - **macOS**: Implementaci√≥n completa, pendiente testing en hardware real
            - **Documentaci√≥n**: Ver [PYTHON_EMBED.md](https://github.com/${{ github.repository }}/blob/main/docs/PYTHON_EMBED.md)
            
            ### Verificaci√≥n
            Para verificar la integridad de los instaladores, consulte los checksums en los artifacts.
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
